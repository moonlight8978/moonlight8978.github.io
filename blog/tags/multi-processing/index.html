<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Blog Atom Feed"><title data-react-helmet="true">Posts tagged &quot;multi-processing&quot; | My Site</title><meta data-react-helmet="true" property="og:title" content="Posts tagged &quot;multi-processing&quot; | My Site"><meta data-react-helmet="true" name="description" content="Blog | Tagged &quot;multi-processing&quot;"><meta data-react-helmet="true" property="og:description" content="Blog | Tagged &quot;multi-processing&quot;"><meta data-react-helmet="true" property="og:url" content="https://your-docusaurus-test-site.com/blog/tags/multi-processing"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://your-docusaurus-test-site.com/blog/tags/multi-processing"><link data-react-helmet="true" rel="alternate" href="https://your-docusaurus-test-site.com/blog/tags/multi-processing" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://your-docusaurus-test-site.com/blog/tags/multi-processing" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.dc5e9681.css">
<link rel="preload" href="/assets/js/runtime~main.753d92b7.js" as="script">
<link rel="preload" href="/assets/js/main.fa35a9da.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">My Site</strong></a><a class="navbar__item navbar__link" href="/docs/intro">Tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ğŸŒ</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">My Site</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/intro">Tutorial</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-page"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/cung-tim-hieu-ve-puma-ruby-on-rails">CÃ¹ng tÃ¬m hiá»ƒu vá» Puma (Ruby on Rails)</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/cuoi-react-native-xem-appium-phan-1-cung-tim-hieu-cach-hoat-dong-cua-appium">CÆ°á»¡i React Native xem Appium (Pháº§n 1 - CÃ¹ng tÃ¬m hiá»ƒu cÃ¡ch hoáº¡t Ä‘á»™ng cá»§a Appium)</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/gioi-thieu-ve-kubernetes">Giá»›i thiá»‡u vá» Kubernetes</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/toi-uu-menh-de-where-mysql">Tá»‘i Æ°u má»‡nh Ä‘á» WHERE (MySQL)</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/cung-tim-hieu-ve-actiontext-trong-rails-6">CÃ¹ng tÃ¬m hiá»ƒu vá» ActionText trong Rails 6</a></li></ul></div></div><main class="col col--7"><h1>One post tagged with &quot;multi-processing&quot;</h1><a href="/blog/tags">View All Tags</a><div class="margin-vert--xl"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/blog/cung-tim-hieu-ve-puma-ruby-on-rails">CÃ¹ng tÃ¬m hiá»ƒu vá» Puma (Ruby on Rails)</a></h2><div class="margin-vert--md"><time datetime="2021-05-31T00:00:00.000Z" class="blogPostDate_fNvV">May 31, 2021 Â· 11 min read</time></div><div class="avatar margin-vert--md"><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer">LÃª SÄ© BÃ­ch</a></h4><small class="avatar__subtitle">Ruby on Rails/React Developer</small></div></div></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="1-má»Ÿ-Ä‘áº§u"></a>1. Má»Ÿ Ä‘áº§u<a class="hash-link" href="#1-má»Ÿ-Ä‘áº§u" title="Direct link to heading">#</a></h2><p>Cháº¯c háº³n Puma khÃ´ng pháº£i má»™t cÃ¡i tÃªn xa láº¡ Ä‘á»‘i vá»›i má»—i Rails developer, má»™t pháº§n cÅ©ng vÃ¬ Ä‘Ã¢y lÃ  appserver máº·c Ä‘á»‹nh khi táº¡o má»›i má»™t project Rails.</p><p>HÃ£y cÃ¹ng nhÃ¬n qua nhá»¯ng config cÆ¡ báº£n khi cháº¡y 1 á»©ng dá»¥ng Rails vá»›i Puma server. <a href="https://github.com/rails/rails/blob/0f5700ac3589081126fbfde1e4037dc1d4166cce/railties/lib/rails/generators/rails/app/templates/config/puma.rb.tt" target="_blank" rel="noopener noreferrer">link</a></p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">config/puma.rb</div><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">max_threads_count = ENV.fetch(&quot;RAILS_MAX_THREADS&quot;) { 5 }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">min_threads_count = ENV.fetch(&quot;RAILS_MIN_THREADS&quot;) { max_threads_count }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">threads min_threads_count, max_threads_count</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">worker_timeout 3600 if ENV.fetch(&quot;RAILS_ENV&quot;, &quot;development&quot;) == &quot;development&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">port ENV.fetch(&quot;PORT&quot;) { 3000 }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">environment ENV.fetch(&quot;RAILS_ENV&quot;) { &quot;development&quot; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pidfile ENV.fetch(&quot;PIDFILE&quot;) { &quot;tmp/pids/server.pid&quot; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">workers ENV.fetch(&quot;WEB_CONCURRENCY&quot;) { 2 }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">preload_app!</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">plugin :tmp_restart</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Äá»‘i vá»›i nhá»¯ng ngÆ°á»i má»›i báº¯t Ä‘áº§u, khi deploy puma, cÃ³ láº½ sáº½ tá»« chá»‘i hiá»ƒu Ä‘á»‘ng config trÃªn vÃ  set má»™t sá»‘ biáº¿n mÃ´i trÆ°á»ng nhÆ° sau:</p><ul><li><code>WEB_CONCURRENCY</code>: báº±ng vá»›i sá»‘ lÆ°á»£ng vcore/process cá»§a mÃ¡y</li><li><code>RAILS_MAX_THREADS</code>: á» thÃ¬ nhiá»u RAM thÃ¬ set 16, 32 cho oÃ¡ch, khÃ´ng thÃ¬ thÃ´i dÃ¹ng máº·c Ä‘á»‹nh 5 vÃ  máº·c do dÃ²ng Ä‘á»i xÃ´ Ä‘áº©y :v</li></ul><p>HÃ£y cÃ¹ng tÃ¬m hiá»ƒu thÃªm vá» Puma Ä‘á»ƒ gÃ³p pháº§n lÃ m chá»§ tá»«ng dÃ²ng code trong app cá»§a chÃºng ta.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="2-multi-processing-vÃ -multi-threading"></a>2. Multi-processing vÃ  Multi-threading<a class="hash-link" href="#2-multi-processing-vÃ -multi-threading" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="21-puma-dÃ¹ng-loáº¡i-nÃ o"></a>2.1. Puma dÃ¹ng loáº¡i nÃ o?<a class="hash-link" href="#21-puma-dÃ¹ng-loáº¡i-nÃ o" title="Direct link to heading">#</a></h3><ul><li>Khi cháº¡y 1 Rails app má»›i táº¡o, hÃ£y Ä‘á»ƒ Ã½ lÃºc boot server, báº¡n sáº½ tháº¥y:</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly log"><div tabindex="0" class="prism-code language-log codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Puma starting in single mode...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">* Puma version: 5.3.1 (ruby 3.0.1-p64) (&quot;Sweetnighter&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">*  Min threads: 5</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">*  Max threads: 5</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">*  Environment: development</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">*          PID: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">* Listening on http://0.0.0.0:3000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Use Ctrl-C to stop</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>ÄÃ¢y lÃ  dáº¥u hiá»‡u cho ta tháº¥y, Rails Ä‘ang cháº¡y á»Ÿ cháº¿ Ä‘á»™ single process (1 process), vÃ  multi-thread (cá»¥ thá»ƒ lÃ  5 thread)</p><ul><li>CÃ²n khi config deploy, cÃ³ thá»ƒ báº¡n sáº½ Ä‘Æ°á»£c 1 ngÆ°á»i cÃ³ kinh nghiá»‡m hÆ¡n báº£o ráº±ng <em>&quot;Bá» comment cÃ¡i dÃ²ng <code>workers ENV.fetch(&quot;WEB_CONCURRENCY&quot;) { 2 }</code> Ä‘i em Ãªi&quot;</em></li></ul><p>VÃ  Ä‘Ã¢y lÃ  káº¿t quáº£ khi ta lÃ m nhÆ° váº­y</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly log"><div tabindex="0" class="prism-code language-log codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] Puma starting in cluster mode...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] * Puma version: 5.3.1 (ruby 3.0.1-p64) (&quot;Sweetnighter&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] *  Min threads: 5</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] *  Max threads: 5</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] *  Environment: development</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] *   Master PID: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] *      Workers: 2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] *     Restarts: (ï¿½ï¿½ï¿½) hot (ï¿½ï¿½ï¿½) phased</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] * Preloading application</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] * Listening on htp://0.0.0.0:3000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] Use Ctrl-C to stop</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] - Worker 0 (PID: 16) booted in 0.02s, phase: 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] - Worker 1 (PID: 17) booted in 0.05s, phase: 0</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Puma Ä‘ang cháº¡y Ä‘á»“ng thá»i multi-process (2 process) vÃ  multi-thread (5 thread)</p><blockquote><p>Multi-process, multi-thread lÃ  cÃ¡i cá»§a ná»£ gÃ¬ váº­y?</p></blockquote><p>ChÃºng ta sáº½ tÃ¬m hiá»ƒu vá» nÃ³ ngay sau Ä‘Ã¢y. Tuy nhiÃªn chÃºng ta sáº½ focus vÃ o cluster mode cá»§a Puma nhÃ©.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="22-multi-threading"></a>2.2. Multi-threading<a class="hash-link" href="#22-multi-threading" title="Direct link to heading">#</a></h3><p>TrÆ°á»›c tiÃªn ta hÃ£y nhá»› láº¡i Ä‘á»‹nh nghÄ©a vá» <code>process</code> - tiáº¿n trÃ¬nh, má»—i khi ta cháº¡y 1 command nÃ o Ä‘Ã³ (vÃ­ dá»¥ nhÆ° <code>ruby xxx.rb</code> hay báº­t chrome cháº³ng háº¡n), OS sáº½ táº¡o 1 process Ä‘á»ƒ xá»­ lÃ½ command cá»§a ta.</p><p>Má»—i <em>process</em> cÃ³ thá»ƒ táº¡o ra nhiá»u <em>thread</em> Ä‘á»ƒ xá»­ lÃ½ task (vÃ­ dá»¥ má»—i tab chrome Ä‘Æ°á»£c handle bá»Ÿi 1 thread). CÃ¡c thread Ä‘Æ°á»£c táº¡o bá»Ÿi 1 process sáº½ share nhau 1 vÃ¹ng nhá»› (memory), trong shared memory nÃ y, má»—i thread sáº½ cÃ³ stack, register (google Ä‘á»ƒ biáº¿t thÃªm Ä‘á»‘ng nÃ y lÃ  gÃ¬ =)) ) riÃªng cá»§a mÃ¬nh. Tuy nhiÃªn, viá»‡c chung Ä‘á»¥ng memory nhÆ° trÃªn sáº½ dáº«n Ä‘áº¿n 1 váº¥n Ä‘á» lÃ  nhiá»u thread cÃ¹ng chá»c tá»›i 1 resource nÃ o Ä‘Ã³, dáº«n tá»›i conflict vá» data, hay cÃ²n Ä‘Æ°á»£c biáº¿t Ä‘áº¿n vá»›i cÃ¡i tÃªn nguy hiá»ƒm hÆ¡n lÃ  <strong>race condition</strong>. Code cá»§a ta sáº½ cáº§n <em>thread-safe</em> (cÃ¡c báº¡n cÃ³ thá»ƒ google thÃªm :v)</p><p>Äá»‘i vá»›i á»©ng dá»¥ng Ruby thÃ¬ khi cháº¡y á»Ÿ mÃ´i trÆ°á»ng MRI... Ã€ Ä‘áº¥y láº¡i nháº¯c tá»›i MRI, cháº¯c nhiá»u ngÆ°á»i sáº½ tháº¯c máº¯c liá»‡u Ä‘Ã³ lÃ  gÃ¬. ÄÃ¢y lÃ  tÃªn cá»§a 1 Ruby Runtime. Ruby 1 chuáº©n spec, implement kiá»ƒu gÃ¬ cÅ©ng Ä‘Æ°á»£c, miá»…n lÃ  Ä‘Ã¡p á»©ng Ä‘Æ°á»£c spec Ä‘Ã³ thÃ¬ Ä‘á»u lÃ  Ruby. CÃ³ thá»ƒ ká»ƒ Ä‘áº¿n cÃ¡c Runtime phá»• biáº¿n sau</p><ul><li><p>MRI - aka CRuby: Matzâ€™s Ruby Interpreter (Matz - hay Matsumoto Yukihiro) lÃ  ngÆ°á»i táº¡o ra runtime nÃ y, Ä‘Æ°á»£c viáº¿t báº±ng C, nÃªn cÃ²n gá»i lÃ  CRuby</p><p>Äa sá»‘ lÃ  dÃ¹ng MRI</p></li><li><p>JRuby: Ruby implement báº±ng Java</p></li><li><p>Rubinius</p></li><li><p>mruby</p></li><li><p>...</p></li></ul><p>MRI cÃ³ 1 cÆ¡ cháº¿ lÃ  <strong>Global Interpreter Lock</strong> (GIL), khi cháº¡y multi-thread, nÃ³ chá»‰ cho phÃ©p 1 thread cháº¡y source code Ruby táº¡i 1 thá»i Ä‘iá»ƒm, nÃªn lÃ  ta cÃ³ nhiá»u thread Ä‘i chÄƒng ná»¯a thÃ¬ cÅ©ng chá»‰ cÃ³ 1 thread Ä‘Æ°á»£c cháº¡y mÃ  thÃ´i.</p><p>Tuy nhiÃªn vá»›i cÃ¡c thao tÃ¡c IO nhÆ° Ä‘á»c DB, request external resource, Ä‘á»c ghi file, ... thÃ¬ GIL khÃ´ng block. Puma Ä‘Ã£ táº­n dá»¥ng Ä‘iá»u nÃ y, khi 1 thread Ä‘ang xá»­ lÃ½ IO, nÃ³ sáº½ quay trá»Ÿ láº¡i xá»­ lÃ½ á»Ÿ process, nháº­n thÃªm cÃ¡c request khÃ¡c Ä‘á»ƒ xá»­ lÃ½.</p><p>ChÃ­nh vÃ¬ váº­y, ngay cáº£ khi chá»‰ cháº¡y á»Ÿ single mode, Puma váº«n cÃ³ thá»ƒ handle Ä‘Æ°á»£c concurrent request. Tuy nhiÃªn vá»›i cÃ¡c request cáº§n thá»i gian dÃ i Ä‘á»ƒ xá»­ lÃ½, do chá»‰ cÃ³ 1 thread Ä‘Æ°á»£c cháº¡y, nÃªn request sau sáº½ pháº£i chá» request trÆ°á»›c xá»­ lÃ½ xong, dáº«n Ä‘áº¿n Puma bá»‹ thá»t trong trÆ°á»ng há»£p nÃ y.</p><p>Ta cÃ³ thá»ƒ kiá»ƒm tra vá» tráº¡ng thÃ¡i cÃ¡c thread cá»§a Puma báº±ng Ä‘oáº¡n code sau:</p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">app/controllers/homes_controller.rb</div><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">class HomesController &lt; ApplicationController</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  def show</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Thread.list.select { |t| t.name&amp;.match?(/puma threadpool \d+/) }.each do |t|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      Rails.logger.info(&quot;Thread #{t.name}: #{t.status}, alive: #{t.alive?}, current: #{t == Thread.current}&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    head :ok</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>VÃ¬ sao láº¡i lÃ  <code>/puma threadpool \d+/</code>? CÃ¡c báº¡n cÃ³ thá»ƒ xem táº¡i <a href="https://github.com/puma/puma/blob/3e80f7c704e5585da4faa32edf0fa7a0abed3689/lib/puma/thread_pool.rb#L104" target="_blank" rel="noopener noreferrer">Ä‘Ã¢y</a>.</p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">config/routes.rb</div><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Rails.application.routes.draw do</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resource :home</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">config/puma.rb</div><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">max_threads_count = ENV.fetch(&#x27;RAILS_MAX_THREADS&#x27;, 5)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">min_threads_count = ENV.fetch(&#x27;RAILS_MIN_THREADS&#x27;) { max_threads_count }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">threads min_threads_count, max_threads_count</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">worker_timeout 3600 if ENV.fetch(&#x27;RAILS_ENV&#x27;, &#x27;development&#x27;) == &#x27;development&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">port ENV.fetch(&#x27;PORT&#x27;, 3000)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">environment ENV.fetch(&#x27;RAILS_ENV&#x27;, &#x27;development&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pidfile ENV.fetch(&#x27;PIDFILE&#x27;, &#x27;tmp/pids/server.pid&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">plugin :tmp_restart</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly curl"><div tabindex="0" class="prism-code language-curl codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">curl http://localhost:3000/home</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tail -n 50 log/development.log</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>VÃ  Ä‘Ã¢y lÃ  output:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly log"><div tabindex="0" class="prism-code language-log codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thread puma threadpool 001: sleep, alive: true, current: false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thread puma threadpool 002: sleep, alive: true, current: false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thread puma threadpool 003: sleep, alive: true, current: false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thread puma threadpool 004: sleep, alive: true, current: false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thread puma threadpool 005: run, alive: true, current: true</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>ÄÃ³ chÃ­nh lÃ  5 thread cá»§a chÃºng ta, nhÆ° vÃ­ dá»¥ lÃ  thread 5 Ä‘ang tiáº¿n hÃ nh xá»­ lÃ½ request, cÃ²n nhá»¯ng thread khÃ¡c náº¿u ráº£nh nÃ³ sáº½ á»Ÿ tráº¡ng thÃ¡i <code>sleep</code>. á» Ä‘Ã¢y cÃ³ 1 Ä‘iá»ƒm Ä‘Ã¡ng chÃº Ã½ lÃ  sau khi káº¿t thÃºc request, thread khÃ´ng bá»‹ kill mÃ  chá»‰ vá» tráº¡ng thÃ¡i <code>sleep</code>, do váº­y náº¿u ta tuá»³ tiá»‡n modify biáº¿n global, nÃ³ sáº½ áº£nh hÆ°á»Ÿng tá»›i request tiáº¿p theo mÃ  thread Ä‘Ã³ handle.</p><p>VÃ­ dá»¥:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">before_action :set_locale</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">def set_locale</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  I18n.locale = params[:locale] || I18n.default_locale</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>KhÃ´ng cáº§n biáº¿t code cÃ¡i gÃ¬, nhÆ°ng modify 1 biáº¿n global táº¡i runtime nhÆ° trÃªn lÃ  Ä‘Ã£ tháº¥y nguy hiá»ƒm rá»“i. VÃ  ta hÃ£y tiáº¿n hÃ nh test xem</p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">app/controllers/homes_controller.rb</div><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">class HomesController &lt; ApplicationController</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  def show</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Thread.current.tap { |t| Rails.logger.info(&quot;Current thread #{t.name}: #{t.status}, alive: #{t.alive?}&quot;) }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Rails.logger.info(&quot;Before: #{I18n.locale}&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    I18n.locale = params[:locale]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Rails.logger.info(&quot;After: #{I18n.locale}&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    head :ok</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>rá»“i sau Ä‘Ã³ spam khoáº£ng chá»¥c cÃ¡i request</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">curl</span><span class="token plain"> http://localhost:3000/home?locale</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">vi</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>vÃ  ta sáº½ tháº¥y káº¿t quáº£ nhÆ° sau</p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">log/development.log</div><div class="codeBlockContent_hGly log"><div tabindex="0" class="prism-code language-log codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Current thread puma threadpool 003: run, alive: true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Before: en</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">After: vi</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Current thread puma threadpool 003: run, alive: true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Before: vi</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">After: vi</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>CÃ³ thá»ƒ dá»… dÃ ng nháº­n ra ráº±ng viá»‡c set <code>I18n.locale = &quot;vi&quot;</code> á»Ÿ request trÆ°á»›c Ä‘Ã£ bá»‹ leak sang request sau. Náº¿u á»Ÿ táº¥t cáº£ cÃ¡c request, trÆ°á»›c khi xá»­ lÃ½ ta Ä‘á»u set <code>I18n.locale</code> thÃ¬ viá»‡c leak trÃªn sáº½ Ã­t áº£nh hÆ°á»Ÿng hÆ¡n.</p><p>Tuy nhiÃªn hÃ£y thá»­ tÆ°á»Ÿng tÆ°á»£ng khi app cá»§a báº¡n cÃ³ chá»©a cáº£ code admin vÃ  api, bÃªn admin cÃ³ thá»ƒ Ä‘á»•i ngÃ´n ngá»¯, cÃ²n api thÃ¬ khÃ´ng, thÃ¬ káº¿t quáº£ sáº½ ra sao. Khi admin Ä‘á»•i ngÃ´n ngá»¯, tÃ¬nh cá», 1 user vÃ´ phÃºc nÃ o Ä‘Ã³ request tá»›i trÃºng cÃ¡i thread vá»«a handle viá»‡c admin Ä‘á»•i ngÃ´n ngá»¯, vÃ  API sáº½ tráº£ vá» locale cá»§a Ã´ng admin kia :v</p><p>ChÃ­nh vÃ¬ váº­y, á»Ÿ docs cá»§a Rails cÅ©ng cÃ³ recommend chÃºng ta xá»­ lÃ½ chuyá»ƒn locale báº±ng <code>I18n.with_locale</code>, cÃ¡c báº¡n cÃ³ thá»ƒ xem táº¡i <a href="https://guides.rubyonrails.org/i18n.html#managing-the-locale-across-requests" target="_blank" rel="noopener noreferrer">Ä‘Ã¢y</a></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">around_action :switch_locale</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">def switch_locale(&amp;action)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  locale = params[:locale] || I18n.default_locale</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  I18n.with_locale(locale, &amp;action)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>TÃºm vÃ¡y láº¡i lÃ  multi-threading há»— trá»£ concurrent ráº¥t tá»‘t, tuy nhiÃªn cÅ©ng áº©n chá»©a 1 vÃ i váº¥n Ä‘á». NÃªn sáº½ cáº§n chÃº Ã½ hÆ¡n khi code.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="23-multi-processing"></a>2.3. Multi-processing<a class="hash-link" href="#23-multi-processing" title="Direct link to heading">#</a></h3><p>MÃ¡y tÃ­nh hiá»‡n nay Ä‘a sá»‘ Ä‘á»u cÃ³ khÃ¡ nhiá»u core, vÃ  Ä‘á»u há»— trá»£ Ä‘a nhiá»‡m Ä‘á»ƒ tá»‘i Æ°u hoÃ¡ viá»‡c xá»­ lÃ½ song song. Váº­y vá»›i webserver thÃ¬ sao? CÃ³ cáº§n chá»©, multi-processing giÃºp ta cÃ³ thá»ƒ xá»­ lÃ½ thÃªm nhiá»u request Ä‘á»“ng thá»i hÆ¡n ná»¯a. Trá»« khi server cá»§a ta quÃ¡ yáº¿u, chá»© khÃ´ng thÃ¬ tá»™i gÃ¬, nhÃ  cháº£ cÃ³ gÃ¬ ngoÃ i core mÃ  láº¡i cháº¡y Ä‘Æ¡n nhÃ¢n thÃ¬ phÃ­ cá»§a giá»i quÃ¡ :v</p><p>Máº·c Ä‘á»‹nh Puma sáº½ cháº¡y á»Ÿ single mode, khi Ä‘Ã³ chá»‰ cÃ³ 1 process, process nÃ y sáº½ Ä‘áº£m nháº­n háº¿t tá»« viá»‡c lÆ°u code cá»§a app, tiáº¿p nháº­n request, ... sau Ä‘Ã³ sáº½ Ä‘áº©y request sang cho cÃ¡c thread xá»­ lÃ½ nhÆ° Ä‘Ã£ mÃ´ táº£ á»Ÿ trÃªn.</p><p>CÃ²n Ä‘á»‘i vá»›i cluster mode, trÆ°á»›c háº¿t Puma sáº½ táº¡o ra má»™t master process. Tá»« process nÃ y, dá»±a vÃ o giÃ¡ trá»‹ cá»§a config dÆ°á»›i, Puma sáº½ <em>fork</em> Ä‘á»ƒ táº¡o ra sá»‘ process tÆ°Æ¡ng á»©ng, hay cÃ²n gá»i lÃ  <em>worker</em>.</p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">config/puma.rb</div><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">workers ENV.fetch(&quot;WEB_CONCURRENCY&quot;) { 2 }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Láº¡i nÃ³i vá» fork, Ä‘Ã¢y lÃ  quÃ¡ trÃ¬nh mÃ  1 process táº¡o ra 1 process má»›i, gá»i lÃ  <em>child process</em>. Má»—i child process Ä‘á»u cÃ³ process id (PID) riÃªng biá»‡t, vÃ  má»™t mÃ´i trÆ°á»ng riÃªng tÃ¡ch biá»‡t hoÃ n toÃ n vá»›i parent process (source code, memory, stack, ...). KhÃ´ng nhÆ° thread váº«n share code vá»›i process, nhÆ°ng cÃ³ stack, register riÃªng. Do váº­y, cÃ³ thá»ƒ nÃ³i forking an toÃ n vÃ  báº£o máº­t hÆ¡n so vá»›i multi-thread.</p><p>Quay trá»Ÿ láº¡i vá»›i Puma, á»Ÿ cluster mode, master process chá»‰ Ä‘áº£m nháº­n viá»‡c tiáº¿p nháº­n request, sau Ä‘Ã³ sáº½ báº¯n sang cÃ¡c worker Ä‘á»ƒ chÃºng tá»± xá»­ vá»›i cÃ¡c thread mÃ  chÃºng spawn. CÃ¡c worker cá»§a Puma Ä‘á»u cÃ³ 1 báº£n copy source code app riÃªng, nÃªn khi cháº¡y nhiá»u worker, hÃ£y cháº¯c cháº¯n lÃ  server cá»§a báº¡n cÃ³ Ä‘á»§ RAM :v</p><p>á» Ruby, cÃ³ thá»ƒ kiá»ƒm tra xem app cá»§a ta Ä‘ang cháº¡y á»Ÿ process nÃ o báº±ng cÃ¡ch sá»­ dá»¥ng</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Process.pid  # Current child process</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Process.ppid # Parent process</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>HÃ£y thá»­ á»Ÿ app Rails cá»§a ta xem</p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">app/controllers/homes_controller.rb</div><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">class HomesController &lt; ApplicationController</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  def show</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Rails.logger.info(&quot;Current: #{Process.pid}. Parent: #{Process.ppid}&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    head :ok</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">config/puma.rb</div><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">workers 2</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">log/development.log</div><div class="codeBlockContent_hGly log"><div tabindex="0" class="prism-code language-log codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Processing by HomesController#show as */*</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Current: 128. Parent: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Processing by HomesController#show as */*</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Current: 129. Parent: 1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">ps</span><span class="token plain"> aux</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># root         1  0.5  7.1 236000 145864 pts/0   Ssl+ 03:28   0:04 puma 5.3.1 (tcp://0.0.0.0:3000) [app]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># root         7  0.0  0.1   3544  3192 pts/1    Ss   03:29   0:00 zsh</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># root       128  0.0  6.9 288680 142008 pts/0   Sl+  03:29   0:00 puma: cluster worker 0: 1 [app]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># root       129  0.0  6.9 288720 142116 pts/0   Sl+  03:29   0:00 puma: cluster worker 1: 1 [app]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># root       219  0.0  0.0   1640   856 pts/1    R+   03:40   0:00 ps aux</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="3-káº¿t-luáº­n"></a>3. Káº¿t luáº­n<a class="hash-link" href="#3-káº¿t-luáº­n" title="Direct link to heading">#</a></h2><p>Cáº£ multi-threading vÃ  multi-processing Ä‘á»u quan trá»ng, chÃºng gÃ³p pháº§n giÃºp app ta xá»­ lÃ½ Ä‘c concurrent request. Hy vá»ng bÃ i viáº¿t cÃ³ thá»ƒ giÃºp Ã­ch cho cÃ¡c báº¡n Ã­t nhiá»u.</p><p>NgoÃ i ra, vá» váº¥n Ä‘á» set sá»‘ worker vÃ  thread á»Ÿ pháº§n Ä‘áº§u Ä‘Ã£ nÃ³i, tá»‘t nháº¥t cháº¯c váº«n lÃ :</p><ul><li><code>WEB_CONCURRENCY</code> = vcore, ngoÃ i ra cÃ²n phá»¥ thuá»™c vÃ o RAM ná»¯a</li><li><code>RAILS_MAX_THREADS</code> khÃ´ng cÃ³ con sá»‘ cá»¥ thá»ƒ, phá»¥ thuá»™c vÃ o RAM vÃ  CPU, nhiá»u RAM, CPU khoáº» thÃ¬ set Ä‘Æ°á»£c cÃ ng nhiá»u, nhÆ°ng cÅ©ng khÃ¡ lÃ  hÃªn xui, pháº£i tiáº¿n hÃ nh test rá»“i má»›i cÄƒn chá»‰nh con sá»‘ phÃ¹ há»£p Ä‘Æ°á»£c =))</li></ul><p>Náº¿u cÃ³ sai sÃ³t gÃ¬ cÃ¡c báº¡n cá»© gáº¡ch Ä‘Ã¡ thoáº£i mÃ¡i Ã  :v chi tiáº¿t cÃ³ thá»ƒ tham kháº£o á»Ÿ <a href="https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server#workers" target="_blank" rel="noopener noreferrer">Ä‘Ã¢y</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="4-tham-kháº£o"></a>4. Tham kháº£o<a class="hash-link" href="#4-tham-kháº£o" title="Direct link to heading">#</a></h2><ul><li><a href="https://www.speedshop.co/2015/07/29/scaling-ruby-apps-to-1000-rpm.html" target="_blank" rel="noopener noreferrer">https://www.speedshop.co/2015/07/29/scaling-ruby-apps-to-1000-rpm.html</a></li><li><a href="https://devcenter.heroku.com/articles/concurrency-and-database-connections" target="_blank" rel="noopener noreferrer">https://devcenter.heroku.com/articles/concurrency-and-database-connections</a></li><li><a href="https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server" target="_blank" rel="noopener noreferrer">https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server</a></li><li><a href="http://www.geekride.com/fork-forking-vs-threading-thread-linux-kernel/" target="_blank" rel="noopener noreferrer">http://www.geekride.com/fork-forking-vs-threading-thread-linux-kernel/</a></li><li><a href="https://www.studytonight.com/operating-system/multithreading" target="_blank" rel="noopener noreferrer">https://www.studytonight.com/operating-system/multithreading</a></li><li><a href="https://www.tutorialspoint.com/how-to-create-a-process-in-linux#:~:text=A%20new%20process%20can%20be,newly%20is%20called%20child%20process" target="_blank" rel="noopener noreferrer">https://www.tutorialspoint.com/how-to-create-a-process-in-linux#:~:text=A%20new%20process%20can%20be,newly%20is%20called%20child%20process</a>.</li></ul></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/puma">puma</a><a class="margin-horiz--sm" href="/blog/tags/ruby-on-rails">ruby-on-rails</a><a class="margin-horiz--sm" href="/blog/tags/multi-threading">multi-threading</a><a class="margin-horiz--sm" href="/blog/tags/multi-processing">multi-processing</a></div><div class="col text--right"><a aria-label="Read more about CÃ¹ng tÃ¬m hiá»ƒu vá» Puma (Ruby on Rails)" href="/blog/cung-tim-hieu-ve-puma-ruby-on-rails"><strong>Read More</strong></a></div></footer></article></div></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.753d92b7.js"></script>
<script src="/assets/js/main.fa35a9da.js"></script>
</body>
</html>